<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nginx 最全操作总结 | 小墨鱼的面试笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/interview/egg.png">
    <meta name="description" content="小墨鱼的面试笔记">
    
    <link rel="preload" href="/interview/assets/css/0.styles.41202823.css" as="style"><link rel="preload" href="/interview/assets/js/app.315fcd90.js" as="script"><link rel="preload" href="/interview/assets/js/3.2951d97b.js" as="script"><link rel="preload" href="/interview/assets/js/30.80f06240.js" as="script"><link rel="prefetch" href="/interview/assets/js/10.7ffca870.js"><link rel="prefetch" href="/interview/assets/js/11.a796a1e1.js"><link rel="prefetch" href="/interview/assets/js/12.c1a92f5b.js"><link rel="prefetch" href="/interview/assets/js/13.e23fb603.js"><link rel="prefetch" href="/interview/assets/js/14.6fe10376.js"><link rel="prefetch" href="/interview/assets/js/15.39fcb4a0.js"><link rel="prefetch" href="/interview/assets/js/16.a28d5ced.js"><link rel="prefetch" href="/interview/assets/js/17.a2ae2507.js"><link rel="prefetch" href="/interview/assets/js/18.f4d5c0b7.js"><link rel="prefetch" href="/interview/assets/js/19.9675a5ad.js"><link rel="prefetch" href="/interview/assets/js/2.51e9aef8.js"><link rel="prefetch" href="/interview/assets/js/20.eff5de6d.js"><link rel="prefetch" href="/interview/assets/js/21.39b07448.js"><link rel="prefetch" href="/interview/assets/js/22.2526b024.js"><link rel="prefetch" href="/interview/assets/js/23.e582a7d7.js"><link rel="prefetch" href="/interview/assets/js/24.6fab991d.js"><link rel="prefetch" href="/interview/assets/js/25.a11720bf.js"><link rel="prefetch" href="/interview/assets/js/26.ad35af4b.js"><link rel="prefetch" href="/interview/assets/js/27.a807c0ff.js"><link rel="prefetch" href="/interview/assets/js/28.43ec09a9.js"><link rel="prefetch" href="/interview/assets/js/29.40a4c8d6.js"><link rel="prefetch" href="/interview/assets/js/31.e254c535.js"><link rel="prefetch" href="/interview/assets/js/32.becfed3a.js"><link rel="prefetch" href="/interview/assets/js/33.169d624d.js"><link rel="prefetch" href="/interview/assets/js/34.e75ce0f2.js"><link rel="prefetch" href="/interview/assets/js/35.cfd2a91d.js"><link rel="prefetch" href="/interview/assets/js/36.813fc716.js"><link rel="prefetch" href="/interview/assets/js/37.1834af1c.js"><link rel="prefetch" href="/interview/assets/js/38.b3a019c6.js"><link rel="prefetch" href="/interview/assets/js/39.c64b6de1.js"><link rel="prefetch" href="/interview/assets/js/4.4edc6fe1.js"><link rel="prefetch" href="/interview/assets/js/40.20696ba5.js"><link rel="prefetch" href="/interview/assets/js/41.364a730f.js"><link rel="prefetch" href="/interview/assets/js/42.ee2aef05.js"><link rel="prefetch" href="/interview/assets/js/43.752ba15f.js"><link rel="prefetch" href="/interview/assets/js/44.667525a3.js"><link rel="prefetch" href="/interview/assets/js/45.b2834a73.js"><link rel="prefetch" href="/interview/assets/js/46.f874b150.js"><link rel="prefetch" href="/interview/assets/js/47.b7dd2d1e.js"><link rel="prefetch" href="/interview/assets/js/48.0b79ef3e.js"><link rel="prefetch" href="/interview/assets/js/49.bb77babc.js"><link rel="prefetch" href="/interview/assets/js/5.5f1bafd5.js"><link rel="prefetch" href="/interview/assets/js/50.66c1fd87.js"><link rel="prefetch" href="/interview/assets/js/51.15241f09.js"><link rel="prefetch" href="/interview/assets/js/52.0d2383ca.js"><link rel="prefetch" href="/interview/assets/js/53.439b2bec.js"><link rel="prefetch" href="/interview/assets/js/6.8b1e859e.js"><link rel="prefetch" href="/interview/assets/js/7.2e1d4b27.js"><link rel="prefetch" href="/interview/assets/js/8.06e19e8e.js"><link rel="prefetch" href="/interview/assets/js/9.98b67c20.js">
    <link rel="stylesheet" href="/interview/assets/css/0.styles.41202823.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/interview/" class="home-link router-link-active"><img src="/interview/egg.png" alt="小墨鱼的面试笔记" class="logo"> <span class="site-name can-hide">小墨鱼的面试笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/interview/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/interview/pages/interview notes/JS 基础知识点.html" class="nav-link">
  面试笔记
</a></div><div class="nav-item"><a href="/interview/pages/interview questions/js基础面试题.html" class="nav-link">
  精选面试题
</a></div><div class="nav-item"><a href="https://github.com/cchroot/interview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/interview/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/interview/pages/interview notes/JS 基础知识点.html" class="nav-link">
  面试笔记
</a></div><div class="nav-item"><a href="/interview/pages/interview questions/js基础面试题.html" class="nav-link">
  精选面试题
</a></div><div class="nav-item"><a href="https://github.com/cchroot/interview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/JS 基础知识点.html" class="sidebar-link">基础知识点</a></li><li><a href="/interview/pages/interview notes/JS 进阶知识点.html" class="sidebar-link">JS 进阶知识点</a></li><li><a href="/interview/pages/interview notes/JS 异步编程.html" class="sidebar-link">异步编程</a></li><li><a href="/interview/pages/interview notes/浏览器与Node的事件循环Event Loop.html" class="sidebar-link">浏览器与Node的事件循环(Event Loop)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JS手写相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/JS 手写相关.html" class="sidebar-link">JS 手写大全</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/性能优化总结.html" class="sidebar-link">性能优化总结</a></li><li><a href="/interview/pages/interview notes/网络协议相关优化.html" class="sidebar-link">网络协议相关优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>浏览器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/浏览器基础知识点.html" class="sidebar-link">浏览器基础知识点</a></li><li><a href="/interview/pages/interview notes/浏览器缓存机制.html" class="sidebar-link">浏览器缓存机制</a></li><li><a href="/interview/pages/interview notes/浏览器渲染原理.html" class="sidebar-link">浏览器渲染原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTTP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/http.html" class="sidebar-link">HTTP知识整合</a></li><li><a href="/interview/pages/interview notes/从输入url到页面展示到底发生了什么.html" class="sidebar-link">从输入url到页面展示到底发生了什么</a></li><li><a href="/interview/pages/interview notes/从输入url开始能做哪些优化.html" class="sidebar-link">从输入url开始能做哪些优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>安全</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/安全防范知识点.html" class="sidebar-link">安全防范知识点</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>监控</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/前端监控.html" class="sidebar-link">前端监控</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue And React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/你能实现一个没有漏洞的双向绑定吗.html" class="sidebar-link">你能实现一个没有漏洞的双向绑定吗</a></li><li><a href="/interview/pages/interview notes/vue源码阅读笔记.html" class="sidebar-link">vue源码阅读笔记</a></li><li><a href="/interview/pages/interview notes/vueRouter源码阅读笔记.html" class="sidebar-link">vueRouter源码阅读笔记</a></li><li><a href="/interview/pages/interview notes/vuex源码阅读笔记.html" class="sidebar-link">vuex源码阅读笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/Webpack 性能优化.html" class="sidebar-link">Webpack 性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>nginx</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/nginx.html" class="active sidebar-link">nginx 操作总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/nginx.html#目录" class="sidebar-link">目录</a></li><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/nginx.html#安装-nginx" class="sidebar-link">安装 nginx</a></li><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/nginx.html#nginx-配置" class="sidebar-link">nginx 配置</a></li><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/nginx.html#nginx-常用功能" class="sidebar-link">nginx 常用功能</a></li><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/nginx.html#其它功能和技巧" class="sidebar-link">其它功能和技巧</a></li><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/nginx.html#常见问题" class="sidebar-link">常见问题</a></li><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/nginx.html#附-nginx-内置预定义变量" class="sidebar-link">附 nginx 内置预定义变量</a></li><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/nginx.html#附-nginx-模块" class="sidebar-link">附 nginx 模块</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/一篇文章入门 redis（万字长文干货）.html" class="sidebar-link">一篇文章入门 redis（万字长文干货）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其它</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/一篇文章搞定 javascript 正则表达式.html" class="sidebar-link">一篇文章搞定 javascript 正则表达式</a></li><li><a href="/interview/pages/interview notes/interview.html" class="sidebar-link">很久很久以前的面试复习一</a></li><li><a href="/interview/pages/interview notes/interview2.html" class="sidebar-link">很久很久以前的面试复习二</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx-最全操作总结"><a href="#nginx-最全操作总结" class="header-anchor">#</a> nginx 最全操作总结</h1> <p>在复习 nginx 的知识的时候把常用的 nginx 操作整合出来，方便查阅，这里分享给大家：</p> <p>本文将会从：安装 -&gt; 全局配置 -&gt; 常用的各种配置 来书写，其中常用配置写的炒鸡详细，需要的童鞋可以直接滑倒相应的位置查看。</p> <h2 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h2> <ul><li><a href="#%E5%AE%89%E8%A3%85-nginx">安装 nginx</a></li> <li><a href="#nginx-%E9%85%8D%E7%BD%AE">nginx 配置</a> <ul><li><a href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84">基本结构</a></li> <li><a href="#%E4%B8%BB%E8%A6%81%E9%85%8D%E7%BD%AE%E5%90%AB%E4%B9%89">主要配置含义</a></li> <li><a href="#nginx-.-conf-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E8%AF%AD%E6%B3%95%E8%A7%84%E5%88%99">nginx.conf 配置文件的语法规则</a></li> <li><a href="#%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F">内置变量</a></li> <li><a href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">常用命令</a></li> <li><a href="#%E9%85%8D%E7%BD%AE-nginx-%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF">配置 nginx 开机自启</a></li> <li><a href="#%E9%85%8D%E7%BD%AE-nginx-%E5%85%A8%E5%B1%80%E5%8F%AF%E7%94%A8">配置 nginx 全局可用</a></li></ul></li> <li><a href="#nginx-%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD%E9%85%8D%E7%BD%AE">nginx 常用功能配置</a> <ul><li><a href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">反向代理</a></li> <li><a href="#%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6">访问控制</a></li> <li><a href="#6-%E7%A7%8D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5">6 种负载均衡策略</a></li> <li><a href="#gzip-%E5%8E%8B%E7%BC%A9">gzip 压缩</a></li> <li><a href="#HTTP-%E6%9C%8D%E5%8A%A1%E5%99%A8">HTTP 服务器</a></li> <li><a href="#%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB">动静分离</a></li> <li><a href="#%E8%AF%B7%E6%B1%82%E9%99%90%E5%88%B6">请求限制</a></li> <li><a href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86">正向代理</a></li> <li><a href="#%E5%9B%BE%E7%89%87%E9%98%B2%E7%9B%97%E9%93%BE">图片防盗链</a></li> <li><a href="#%E9%80%82%E9%85%8D-PC-%E6%88%96%E7%A7%BB%E5%8A%A8%E8%AE%BE%E5%A4%87">适配 PC 或移动设备</a></li> <li><a href="#%E8%AE%BE%E7%BD%AE%E4%BA%8C%E7%BA%A7%E5%9F%9F%E5%90%8D">设置二级域名</a></li> <li><a href="#%E9%85%8D%E7%BD%AE-HTTPS">配置 HTTPS</a></li> <li><a href="#%E9%85%8D%E7%BD%AE-HTTP-%E8%BD%AC-HTTPS">配置 HTTP 转 HTTPS</a></li> <li><a href="#%E5%8D%95%E9%A1%B5%E9%9D%A2%E9%A1%B9%E7%9B%AE-history-%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE">单页面项目 history 路由配置</a></li> <li><a href="#%E9%85%8D%E7%BD%AE%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%8F%8C%E6%9C%BA%E7%83%AD%E5%A4%87%EF%BC%89">配置高可用集群（双机热备）</a></li></ul></li> <li><a href="#%E5%85%B6%E5%AE%83%E5%8A%9F%E8%83%BD%E5%92%8C%E6%8A%80%E5%B7%A7%E9%85%8D%E7%BD%AE">其它功能和技巧配置</a> <ul><li><a href="#%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98">代理缓存</a></li> <li><a href="#%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97">访问日志</a></li> <li><a href="#%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97">错误日志</a></li> <li><a href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8">静态资源服务器</a></li> <li><a href="#%E7%A6%81%E6%AD%A2%E6%8C%87%E5%AE%9A-user_agent">禁止指定 user_agent</a></li> <li><a href="#%E8%AF%B7%E6%B1%82%E8%BF%87%E6%BB%A4">请求过滤</a></li> <li><a href="#ab-%E5%91%BD%E4%BB%A4">ab 命令</a></li> <li><a href="#%E6%B3%9B%E5%9F%9F%E5%90%8D%E8%B7%AF%E5%BE%84%E5%88%86%E7%A6%BB">泛域名路径分离</a></li> <li><a href="#%E6%B3%9B%E5%9F%9F%E5%90%8D%E8%BD%AC%E5%8F%91">泛域名转发</a></li></ul></li> <li><a href="#%E9%99%84-nginx-%E6%A8%A1%E5%9D%97">附 nginx 模块</a> <ul><li><a href="#nginx-%E6%A8%A1%E5%9D%97%E5%88%86%E7%B1%BB">nginx 模块分类</a></li> <li><a href="#%E6%A8%A1%E5%9D%97%E6%B8%85%E5%8D%95">模块清单</a></li></ul></li></ul> <h2 id="安装-nginx"><a href="#安装-nginx" class="header-anchor">#</a> 安装 nginx</h2> <p><strong>下载 nginx 的压缩包文件到根目录，官网下载地址：nginx.org/download/nginx-x.xx.xx.tar.gz</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum update <span class="token comment">#更新系统软件</span>
<span class="token builtin class-name">cd</span> /
<span class="token function">wget</span> nginx.org/download/nginx-1.17.2.tar.gz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>解压tar.gz压缩包文件，进去 nginx-1.17.2</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">tar</span> -xzvf nginx-1.17.2.tar.gz 
<span class="token builtin class-name">cd</span> nginx-1.17.2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>进入文件夹后进行配置检查</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>./configure
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>通过安装前的配置检查，发现有报错。检查中发现一些依赖库没有找到，这时候需要先安装nginx的一些依赖库</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum -y <span class="token function">install</span> pcre* <span class="token comment">#安装使nginx支持rewrite</span>
yum -y <span class="token function">install</span> gcc-c++    
yum -y <span class="token function">install</span> zlib*
yum -y <span class="token function">install</span> openssl openssl-devel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>再次进行检查操作 ./configure 没发现报错显示，接下来进行编译并安装的操作</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code> // 检查模块支持
  ./configure  --prefix<span class="token operator">=</span>/usr/local/nginx  --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_auth_request_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-mail --with-mail_ssl_module --with-stream --with-stream_ssl_module --with-stream_realip_module --with-stream_ssl_preread_module --with-threads --user<span class="token operator">=</span>www --group<span class="token operator">=</span>www
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里得特别注意下，你以后需要用到的功能模块是否存在，不然以后添加新的包会比较麻烦。</p> <p><strong>查看默认安装的模块支持</strong></p> <p>命令 <code>ls nginx-1.17.2</code> 查看 nginx 的文件列表，可以发现里面有一个 auto 的目录。</p> <p>在这个 auto 目录中有一个 options 文件，这个文件里面保存的就是 nginx 编译过程中的所有选项配置。</p> <p>通过命令：<code>cat nginx-1.17.2/auto/options | grep YES</code>就可以查看</p> <p><a href="https://jingyan.baidu.com/article/454316ab354edcf7a7c03a81.html" target="_blank" rel="noopener noreferrer">nginx 编译安装时，怎么查看安装模块<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>编译并安装</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>make &amp;&amp; make install
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里需要注意，模块的支持跟后续的nginx配置有关，比如 SSL，gzip 压缩等等，编译安装前最好检查需要配置的模块存不存在。</p> <p><strong>查看 nginx 安装后在的目录，可以看到已经安装到 /usr/local/nginx 目录了</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">whereis</span> nginx
<span class="token variable">$nginx</span><span class="token builtin class-name">:</span> /usr/local/nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>启动 nginx 服务</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /usr/local/nginx/sbin/
./nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>服务启动的时候报错了：<code>nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</code> ，通过命令查看本机网络地址和端口等一些信息，找到被占用的 80 端口 <code>netstat -ntpl</code> 的 tcp 连接，并杀死进程(kill  进程 pid)</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">netstat</span> -ntpl
<span class="token function">kill</span> 进程PID
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>继续启动 nginx 服务，启动成功</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>./nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在浏览器直接访问 ip 地址，页面出现 Welcome to Nginx! 则安装成功。</p> <h2 id="nginx-配置"><a href="#nginx-配置" class="header-anchor">#</a> nginx 配置</h2> <h3 id="基本结构"><a href="#基本结构" class="header-anchor">#</a> 基本结构</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>main        <span class="token comment"># 全局配置，对全局生效</span>
├── events  <span class="token comment"># 配置影响 nginx 服务器或与用户的网络连接</span>
├── http    <span class="token comment"># 配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置</span>
│   ├── upstream <span class="token comment"># 配置后端服务器具体地址，负载均衡配置不可或缺的部分</span>
│   ├── server   <span class="token comment"># 配置虚拟主机的相关参数，一个 http 块中可以有多个 server 块</span>
│   ├── server
│   │   ├── location  <span class="token comment"># server 块可以包含多个 location 块，location 指令用于匹配 uri</span>
│   │   ├── location
│   │   └── <span class="token punctuation">..</span>.
│   └── <span class="token punctuation">..</span>.
└── <span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="主要配置含义"><a href="#主要配置含义" class="header-anchor">#</a> 主要配置含义</h3> <ul><li>main:nginx 的全局配置，对全局生效。</li> <li>events:配置影响 nginx 服务器或与用户的网络连接。</li> <li>http：可以嵌套多个 server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。</li> <li>server：配置虚拟主机的相关参数，一个 http 中可以有多个server。</li> <li>location：配置请求的路由，以及各种页面的处理情况。</li> <li>upstream：配置后端服务器具体地址，负载均衡配置不可或缺的部分。</li></ul> <h3 id="nginx-conf-配置文件的语法规则"><a href="#nginx-conf-配置文件的语法规则" class="header-anchor">#</a> nginx.conf 配置文件的语法规则</h3> <ol><li>配置文件由指令与指令块构成</li> <li>每条指令以 “;” 分号结尾，指令与参数间以空格符号分隔</li> <li>指令块以 {} 大括号将多条指令组织在一起</li> <li>include 语句允许组合多个配置文件以提升可维护性</li> <li>通过 # 符号添加注释，提高可读性</li> <li>通过 $ 符号使用变量</li> <li>部分指令的参数支持正则表达式，例如常用的 location 指令</li></ol> <h3 id="内置变量"><a href="#内置变量" class="header-anchor">#</a> 内置变量</h3> <p>nginx 常用的内置全局变量，你可以在配置中随意使用：</p> <table><thead><tr><th style="text-align:center;">TCP</th> <th style="text-align:center;">UDP</th></tr></thead> <tbody><tr><td style="text-align:center;">$host</td> <td style="text-align:center;">请求信息中的 Host，如果请求中没有 Host 行，则等于设置的服务器名</td></tr> <tr><td style="text-align:center;">$request_method</td> <td style="text-align:center;">客户端请求类型，如 GET、POST</td></tr> <tr><td style="text-align:center;">$remote_addr</td> <td style="text-align:center;">客户端的 IP 地址</td></tr> <tr><td style="text-align:center;">$args</td> <td style="text-align:center;">请求中的参数</td></tr> <tr><td style="text-align:center;">$content_length</td> <td style="text-align:center;">请求头中的 Content-length 字段</td></tr> <tr><td style="text-align:center;">$http_user_agent</td> <td style="text-align:center;">客户端 agent 信息</td></tr> <tr><td style="text-align:center;">$http_cookie</td> <td style="text-align:center;">客户端cookie信息</td></tr> <tr><td style="text-align:center;">$remote_port</td> <td style="text-align:center;">客户端的端口</td></tr> <tr><td style="text-align:center;">$server_protocol</td> <td style="text-align:center;">请求使用的协议，如 HTTP/1.1</td></tr> <tr><td style="text-align:center;">$server_addr</td> <td style="text-align:center;">服务器地址</td></tr> <tr><td style="text-align:center;">$server_name</td> <td style="text-align:center;">服务器名称</td></tr> <tr><td style="text-align:center;">$server_port</td> <td style="text-align:center;">服务器的端口号</td></tr></tbody></table> <h3 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h3> <p>这里列举几个常用的命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>nginx -s reload  <span class="token comment"># 向主进程发送信号，重新加载配置文件，热重启</span>
nginx -s reopen	 <span class="token comment"># 重启 Nginx</span>
nginx -s stop    <span class="token comment"># 快速关闭</span>
nginx -s quit    <span class="token comment"># 等待工作进程处理完成后关闭</span>
nginx -T         <span class="token comment"># 查看当前 Nginx 最终的配置</span>
nginx -t -c <span class="token operator">&lt;</span>配置路径<span class="token operator">&gt;</span>  <span class="token comment"># 检查配置是否有问题，如果已经在配置目录，则不需要 -c</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>以上命令通过 <code>nginx -h</code> 就可以查看到，还有其它不常用这里未列出。</p> <p>Linux 系统应用管理工具 systemd 关于 nginx 的常用命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl start nginx    <span class="token comment"># 启动 Nginx</span>
systemctl stop nginx     <span class="token comment"># 停止 Nginx</span>
systemctl restart nginx  <span class="token comment"># 重启 Nginx</span>
systemctl reload nginx   <span class="token comment"># 重新加载 Nginx，用于修改配置后</span>
systemctl <span class="token builtin class-name">enable</span> nginx   <span class="token comment"># 设置开机启动 Nginx</span>
systemctl disable nginx  <span class="token comment"># 关闭开机启动 Nginx</span>
systemctl status nginx   <span class="token comment"># 查看 Nginx 运行状态</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="配置-nginx-开机自启"><a href="#配置-nginx-开机自启" class="header-anchor">#</a> 配置 nginx 开机自启</h3> <p><strong>利用 systemctl 命令</strong>：</p> <p>如果用 yum install 命令安装的 nginx，yum 命令会自动创建 nginx.service 文件，直接用命令:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>systemctl enable nginx   # 设置开机启动 Nginx
systemctl disable nginx  # 关闭开机启动 Nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>就可以设置开机自启，否则需要在系统服务目录里创建 nginx.service 文件。</p> <p>创建并打开 nginx.service 文件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vi</span> /lib/systemd/system/nginx.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>内容如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>nginx
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target
  
<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/nginx/sbin/nginx
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/usr/local/nginx/sbin/nginx -s reload
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/local/nginx/sbin/nginx -s quit
<span class="token assign-left variable">PrivateTmp</span><span class="token operator">=</span>true
  
<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>:wq</code> 保存退出，运行 <code>systemctl daemon-reload</code> 使文件生效。</p> <p>这样便可以通过以下命令操作 nginx 了：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl start nginx.service <span class="token comment"># 启动nginx服务</span>
systemctl <span class="token builtin class-name">enable</span> nginx.service <span class="token comment"># 设置开机启动</span>
systemctl disable nginx.service <span class="token comment"># 停止开机自启动</span>
systemctl status nginx.service　<span class="token comment"># 查看服务当前状态</span>
systemctl restart nginx.service <span class="token comment"># 重新启动服务</span>
systemctl is-enabled nginx.service <span class="token comment">#查询服务是否开机启动</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>通过开机启动命令脚本实现开机自启</strong></p> <p>创建开机启动命令脚本文件：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">vi</span> /etc/init.d/nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在这个 nginx 文件中插入一下启动脚本代码，启动脚本代码来源网络复制，实测有效：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token shebang important">#! /bin/bash</span>
<span class="token comment"># chkconfig: - 85 15</span>
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/nginx
<span class="token assign-left variable">DESC</span><span class="token operator">=</span><span class="token string">&quot;nginx daemon&quot;</span>
<span class="token assign-left variable">NAME</span><span class="token operator">=</span>nginx
<span class="token assign-left variable">DAEMON</span><span class="token operator">=</span><span class="token environment constant">$PATH</span>/sbin/<span class="token variable">$NAME</span>
<span class="token assign-left variable">CONFIGFILE</span><span class="token operator">=</span><span class="token environment constant">$PATH</span>/conf/<span class="token variable">$NAME</span>.conf
<span class="token assign-left variable">PIDFILE</span><span class="token operator">=</span><span class="token environment constant">$PATH</span>/logs/<span class="token variable">$NAME</span>.pid
<span class="token assign-left variable">scriptNAME</span><span class="token operator">=</span>/etc/init.d/<span class="token variable">$NAME</span>
<span class="token builtin class-name">set</span> -e
<span class="token punctuation">[</span> -x <span class="token string">&quot;<span class="token variable">$DAEMON</span>&quot;</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span>
<span class="token function-name function">do_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token variable">$DAEMON</span> -c <span class="token variable">$CONFIGFILE</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> -n <span class="token string">&quot;nginx already running&quot;</span>
<span class="token punctuation">}</span>
<span class="token function-name function">do_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token variable">$DAEMON</span> -s stop <span class="token operator">||</span> <span class="token builtin class-name">echo</span> -n <span class="token string">&quot;nginx not running&quot;</span>
<span class="token punctuation">}</span>
<span class="token function-name function">do_reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token variable">$DAEMON</span> -s reload <span class="token operator">||</span> <span class="token builtin class-name">echo</span> -n <span class="token string">&quot;nginx can't reload&quot;</span>
<span class="token punctuation">}</span>
<span class="token keyword">case</span> <span class="token string">&quot;<span class="token variable">$1</span>&quot;</span> <span class="token keyword">in</span>
start<span class="token punctuation">)</span>
<span class="token builtin class-name">echo</span> -n <span class="token string">&quot;Starting <span class="token variable">$DESC</span>: <span class="token variable">$NAME</span>&quot;</span>
do_start
<span class="token builtin class-name">echo</span> <span class="token string">&quot;.&quot;</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
stop<span class="token punctuation">)</span>
<span class="token builtin class-name">echo</span> -n <span class="token string">&quot;Stopping <span class="token variable">$DESC</span>: <span class="token variable">$NAME</span>&quot;</span>
do_stop
<span class="token builtin class-name">echo</span> <span class="token string">&quot;.&quot;</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
reload<span class="token operator">|</span>graceful<span class="token punctuation">)</span>
<span class="token builtin class-name">echo</span> -n <span class="token string">&quot;Reloading <span class="token variable">$DESC</span> configuration...&quot;</span>
do_reload
<span class="token builtin class-name">echo</span> <span class="token string">&quot;.&quot;</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
restart<span class="token punctuation">)</span>
<span class="token builtin class-name">echo</span> -n <span class="token string">&quot;Restarting <span class="token variable">$DESC</span>: <span class="token variable">$NAME</span>&quot;</span>
do_stop
do_start
<span class="token builtin class-name">echo</span> <span class="token string">&quot;.&quot;</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
*<span class="token punctuation">)</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Usage: <span class="token variable">$scriptNAME</span> {start|stop|reload|restart}&quot;</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span>
<span class="token builtin class-name">exit</span> <span class="token number">3</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span>
<span class="token builtin class-name">exit</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>设置所有人都有对这个启动脚本 nginx 文件的执行权限：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">chmod</span> a+x /etc/init.d/nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>把nginx加入系统服务中：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">chkconfig</span> --add nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>把服务设置为开机启动：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">chkconfig</span> nginx on
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>reboot 重启系统生效，可以使用上面 systemctl 方法相同的命令：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl start nginx.service <span class="token comment"># 启动nginx服务</span>
systemctl <span class="token builtin class-name">enable</span> nginx.service <span class="token comment"># 设置开机启动</span>
systemctl disable nginx.service <span class="token comment"># 停止开机自启动</span>
systemctl status nginx.service　<span class="token comment"># 查看服务当前状态</span>
systemctl restart nginx.service <span class="token comment"># 重新启动服务</span>
systemctl is-enabled nginx.service <span class="token comment">#查询服务是否开机启动</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>如果服务启动的时候出现 <code>Restarting nginx daemon: nginxnginx: [error] open() &quot;/usr/local/nginx/logs/nginx.pid&quot; failed (2: No such file or directory) nginx not running</code> 的错误，通过nginx -c 参数指定配置文件即可解决</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果服务启动中出现 <code>nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</code> 的错误，可以先通过 <code>service nginx stop</code> 停止服务，再启动就好。</p> <h3 id="配置-nginx-全局可用"><a href="#配置-nginx-全局可用" class="header-anchor">#</a> 配置 nginx 全局可用</h3> <p>当你每次改了 <code>nginx.conf</code> 配置文件的内容都需要重新到 nginx 启动目录去执行命令，或者通过 -p 参数指向特定目录，会不会感觉很麻烦？</p> <p>例如： 直接执行 <code>nginx -s reload</code> 会报错 <code>-bash: nginx: command not found</code>，需要到 <code>/usr/local/nginx/sbin</code> 目录下面去执行，并且是执行 <code>./nginx -s reload</code>。</p> <p>这里有两种方式可以解决，一种是通过脚本对 nginx 命令包装，这里介绍另外一种比较简单：通过把 nginx 配置到环境变量里，用 nginx 执行指令即可。步骤如下：</p> <p>1、编辑 /etc/profile</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vi</span> /etc/profile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2、在最后一行添加配置，:wq 保存</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span>:/usr/local/nginx/sbin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3、使配置立即生效</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">source</span> /etc/profile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样就可以愉快的直接在全局使用 nginx 命令了。</p> <h2 id="nginx-常用功能"><a href="#nginx-常用功能" class="header-anchor">#</a> nginx 常用功能</h2> <h3 id="反向代理"><a href="#反向代理" class="header-anchor">#</a> 反向代理</h3> <p>我们最常说的反向代理的是通过反向代理解决跨域问题。</p> <p>其实反向代理还可以用来控制缓存（代理缓存 proxy cache），进行访问控制等等，以及后面说的负载均衡其实都是通过反向代理来实现的。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
    listen    <span class="token number">8080</span><span class="token punctuation">;</span>
        <span class="token comment"># 用户访问 ip:8080/test 下的所有路径代理到 github</span>
        location /test <span class="token punctuation">{</span>
        	proxy_pass   https://github.com<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment"># 所有 /api 下的接口访问都代理到本地的 8888 端口</span>
        <span class="token comment"># 例如你本地运行的 java 服务的端口是 8888，接口都是以 /api 开头</span>
        location /api <span class="token punctuation">{</span>
            proxy_pass   http://127.0.0.1:8888<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="访问控制"><a href="#访问控制" class="header-anchor">#</a> 访问控制</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
   location ~ ^/index.html <span class="token punctuation">{</span>
       <span class="token comment"># 匹配 index.html 页面 除了 127.0.0.1 以外都可以访问</span>
       deny <span class="token number">192.168</span>.1.1<span class="token punctuation">;</span>
       deny <span class="token number">192.168</span>.1.2<span class="token punctuation">;</span>
       allow all<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>上面的命令表示禁止 192.168.1.1 和 192.168.1.2 两个 ip 访问，其它全部允许。从上到下的顺序，匹配到了便跳出，可以按你的需求设置。</p> <h3 id="负载均衡"><a href="#负载均衡" class="header-anchor">#</a> 负载均衡</h3> <p>通过负载均衡充利用服务器资源，nginx 目前支持自带 4 种负载均衡策略，还有 2 种常用的第三方策略。</p> <p><strong>轮询策略（默认）</strong></p> <p>每个请求按时间顺序逐一分配到不同的后端服务器，如果有后端服务器挂掉，能自动剔除。但是如果其中某一台服务器压力太大，出现延迟，会影响所有分配在这台服务器下的用户。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>http <span class="token punctuation">{</span>
    upstream test.com <span class="token punctuation">{</span>
        server <span class="token number">192.168</span>.1.12:8887<span class="token punctuation">;</span>
        server <span class="token number">192.168</span>.1.13:8888<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    server <span class="token punctuation">{</span>
        location /api <span class="token punctuation">{</span>
            proxy_pass  http://test.com<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>根据服务器权重</strong></p> <p>例如要配置：10 次请求中大概 1 次访问到 8888 端口，9 次访问到 8887 端口：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>http <span class="token punctuation">{</span>
    upstream test.com <span class="token punctuation">{</span>
        server <span class="token number">192.168</span>.1.12:8887 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span>
        server <span class="token number">192.168</span>.1.13:8888 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    server <span class="token punctuation">{</span>
        location /api <span class="token punctuation">{</span>
            proxy_pass  http://test.com<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>客户端 ip 绑定（ip_hash）</strong></p> <p>来自同一个 ip 的请求永远只分配一台服务器，有效解决了动态网页存在的 session 共享问题。例如：比如把登录信息保存到了 session 中，那么跳转到另外一台服务器的时候就需要重新登录了。</p> <p>所以很多时候我们需要一个客户只访问一个服务器，那么就需要用 ip_hash 了。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>http <span class="token punctuation">{</span>
    upstream test.com <span class="token punctuation">{</span>
    	ip_hash<span class="token punctuation">;</span>
        server <span class="token number">192.168</span>.1.12:8887<span class="token punctuation">;</span>
        server <span class="token number">192.168</span>.1.13:8888<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    server <span class="token punctuation">{</span>
        location /api <span class="token punctuation">{</span>
            proxy_pass  http://test.com<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>最小连接数策略</strong></p> <p>将请求优先分配给压力较小的服务器，它可以平衡每个队列的长度，并避免向压力大的服务器添加更多的请求。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>http <span class="token punctuation">{</span>
    upstream test.com <span class="token punctuation">{</span>
    	least_conn<span class="token punctuation">;</span>
        server <span class="token number">192.168</span>.1.12:8887<span class="token punctuation">;</span>
        server <span class="token number">192.168</span>.1.13:8888<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    server <span class="token punctuation">{</span>
        location /api <span class="token punctuation">{</span>
            proxy_pass  http://test.com<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>最快响应时间策略（依赖于第三方 NGINX Plus）</strong></p> <p>依赖于 NGINX Plus，优先分配给响应时间最短的服务器。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>http <span class="token punctuation">{</span>
    upstream test.com <span class="token punctuation">{</span>
    	fair<span class="token punctuation">;</span>
        server <span class="token number">192.168</span>.1.12:8887<span class="token punctuation">;</span>
        server <span class="token number">192.168</span>.1.13:8888<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    server <span class="token punctuation">{</span>
        location /api <span class="token punctuation">{</span>
            proxy_pass  http://test.com<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>按访问url的hash结果（第三方）</strong></p> <p>按访问 url 的 hash 结果来分配请求，使每个 url 定向到同一个后端服务器，后端服务器为缓存时比较有效。 在 upstream 中加入 hash 语句，server 语句中不能写入 weight 等其他的参数，hash_method 是使用的 hash 算法</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>
http <span class="token punctuation">{</span>
    upstream test.com <span class="token punctuation">{</span>
    	<span class="token builtin class-name">hash</span> <span class="token variable">$request_uri</span><span class="token punctuation">;</span> 
    	hash_method crc32<span class="token punctuation">;</span> 
    	server <span class="token number">192.168</span>.1.12:8887<span class="token punctuation">;</span>
    	server <span class="token number">192.168</span>.1.13:8888<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    server <span class="token punctuation">{</span>
        location /api <span class="token punctuation">{</span>
            proxy_pass  http://test.com<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>采用 HAproxy 的 loadbalance uri 或者 nginx 的 upstream_hash 模块，都可以做到针对 url 进行哈希算法式的负载均衡转发。</p> <h3 id="gzip-压缩"><a href="#gzip-压缩" class="header-anchor">#</a> gzip 压缩</h3> <p>开启 gzip 压缩可以大幅减少 http 传输过程中文件的大小，可以极大的提高网站的访问速度，基本是必不可少的优化操作：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">gzip</span>  on<span class="token punctuation">;</span> <span class="token comment"># 开启gzip 压缩</span>
<span class="token comment"># gzip_types</span>
<span class="token comment"># gzip_static on;</span>
<span class="token comment"># gzip_proxied expired no-cache no-store private auth;</span>
<span class="token comment"># gzip_buffers 16 8k;</span>
gzip_min_length 1k<span class="token punctuation">;</span>
gzip_comp_level <span class="token number">4</span><span class="token punctuation">;</span>
gzip_http_version <span class="token number">1.0</span><span class="token punctuation">;</span>
gzip_vary off<span class="token punctuation">;</span>
gzip_disable <span class="token string">&quot;MSIE [1-6]\.&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>解释一下：</p> <ol><li>gzip_types：要采用 gzip 压缩的 MIME 文件类型，其中 text/html 被系统强制启用；</li> <li>gzip_static：默认 off，该模块启用后，Nginx 首先检查是否存在请求静态文件的 gz 结尾的文件，如果有则直接返回该 .gz 文件内容；</li> <li>gzip_proxied：默认 off，nginx 做为反向代理时启用，用于设置启用或禁用从代理服务器上收到相应内容 gzip 压缩；</li> <li>gzip_buffers：获取多少内存用于缓存压缩结果，16 8k 表示以 8k*16 为单位获得；</li> <li>gzip_min_length：允许压缩的页面最小字节数，页面字节数从 header 头中的 Content-Length 中进行获取。默认值是 0，不管页面多大都压缩。建议设置成大于 1k 的字节数，小于 1k 可能会越压越大；</li> <li>gzip_comp_level：gzip 压缩比，压缩级别是 1-9，1 压缩级别最低，9 最高，级别越高压缩率越大，压缩时间越长，建议 4-6；</li> <li>gzip_http_version：默认 1.1，启用 gzip 所需的 HTTP 最低版本；</li> <li>gzip_vary：用于在响应消息头中添加 Vary：Accept-Encoding，使代理服务器根据请求头中的 Accept-Encoding 识别是否启用 gzip 压缩；</li> <li>gzip_disable 指定哪些不需要 gzip 压缩的浏览器</li></ol> <p>其中第 2 点，普遍是结合前端打包的时候打包成 gzip 文件后部署到服务器上，这样服务器就可以直接使用 gzip 的文件了，并且可以把压缩比例提高，这样 nginx 就不用压缩，也就不会影响速度。一般不追求极致的情况下，前端不用做任何配置就可以使用啦~</p> <p>附前端 webpack 开启 gzip 压缩配置，在 vue-cli3 的 vue.config.js 配置文件中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> CompressionWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'compression-webpack-plugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// gzip 配置</span>
  <span class="token function-variable function">configureWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 生产环境</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">CompressionWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$|\.html$|\.css</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>    <span class="token comment">// 匹配文件名</span>
          threshold<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>               <span class="token comment">// 文件压缩阈值，对超过 1k 的进行压缩</span>
          deleteOriginalAssets<span class="token operator">:</span> <span class="token boolean">false</span>     <span class="token comment">// 是否删除源文件</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="http服务器"><a href="#http服务器" class="header-anchor">#</a> HTTP服务器</h3> <p>nginx 本身也是一个静态资源的服务器，当只有静态资源的时候，就可以使用 nginx 来做服务器：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
  listen       <span class="token number">80</span><span class="token punctuation">;</span>                                                     
  server_name  localhost<span class="token punctuation">;</span>                                           

  location / <span class="token punctuation">{</span>
      root   /usr/local/app<span class="token punctuation">;</span>
      index  index.html<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这样如果访问 http://ip 就会默认访问到 /usr/local/app 目录下面的 index.html，如果一个网站只是静态页面的话，那么就可以通过这种方式来实现部署，比如一个静态官网。</p> <h3 id="动静分离"><a href="#动静分离" class="header-anchor">#</a> 动静分离</h3> <p>就是把动态和静态的请求分开。方式主要有两种：</p> <ul><li>一种是纯粹把静态文件独立成单独的域名，放在独立的服务器上，也是目前主流推崇的方案</li> <li>一种方法就是动态跟静态文件混合在一起发布， 通过 nginx 配置来分开</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code># 所有静态请求都由nginx处理，存放目录为	html  
location ~ \.(gif|jpg|jpeg|png|bmp|swf|css|js)$ {  
    root    /usr/local/resource;
    expires     10h; # 设置过期时间为10小时  
}  

# 所有动态请求都转发给 tomcat 处理  
location ~ \.(jsp|do)$ {
    proxy_pass  127.0.0.1:8888;  
}  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>注意上面设置了 expires，当 nginx 设置了 expires 后，例如设置为：expires 10d;  那么，所在的 location 或 if 的内容，用户在 10 天内请求的时候，都只会访问浏览器中的缓存，而不会去请求 nginx 。</p> <h3 id="请求限制"><a href="#请求限制" class="header-anchor">#</a> 请求限制</h3> <p>对于大流量恶意的访问，会造成带宽的浪费，给服务器增加压力。可以通过 nginx 对于同一 IP 的连接数以及并发数进行限制。合理的控制还可以用来防止 DDos 和 CC 攻击。</p> <p>关于请求限制主要使用 nginx 默认集成的 2 个模块：</p> <ul><li>limit_conn_module 连接频率限制模块</li> <li>limit_req_module 请求频率限制模块</li></ul> <p>涉及到的配置主要是：</p> <ul><li>limit_req_zone 限制请求数</li> <li>limit_conn_zone 限制并发连接数</li></ul> <p><strong>通过 limit_req_zone 限制请求数</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>http<span class="token punctuation">{</span>
    limit_conn_zone <span class="token variable">$binary_remote_addrzone</span><span class="token operator">=</span>limit:10m<span class="token punctuation">;</span> // 设置共享内存空间大
    server<span class="token punctuation">{</span>
    	location /<span class="token punctuation">{</span>
            limit_conn addr <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment"># 同一用户地址同一时间只允许有5个连接。</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果共享内存空间被耗尽，服务器将会对后续所有的请求返回 503 (Service Temporarily Unavailable) 错误。</p> <p>当多个 limit_conn_zone 指令被配置时，所有的连接数限制都会生效。比如，下面配置不仅会限制单一 IP 来源的连接数，同时也会限制单一虚拟服务器的总连接数：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>limit_conn_zone <span class="token variable">$binary_remote_addr</span> <span class="token assign-left variable">zone</span><span class="token operator">=</span>perip:10m<span class="token punctuation">;</span>
limit_conn_zone <span class="token variable">$server_name</span> <span class="token assign-left variable">zone</span><span class="token operator">=</span>perserver:10m<span class="token punctuation">;</span>
server <span class="token punctuation">{</span>
    limit_conn perip <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment"># 限制每个 ip 连接到服务器的数量</span>
    limit_conn perserver <span class="token number">2000</span><span class="token punctuation">;</span> <span class="token comment"># 限制连接到服务器的总数</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>通过 limit_conn_zone 限制并发连接数</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>limit_req_zone <span class="token variable">$binary_remote_addr</span> <span class="token assign-left variable">zone</span><span class="token operator">=</span>creq:10 <span class="token assign-left variable">mrate</span><span class="token operator">=</span>10r/s<span class="token punctuation">;</span>
server<span class="token punctuation">{</span>
    location /<span class="token punctuation">{</span>
        limit_req <span class="token assign-left variable">zone</span><span class="token operator">=</span>creq <span class="token assign-left variable">burst</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>限制平均每秒不超过一个请求，同时允许超过频率限制的请求数不多于5个。
如果不希望超过的请求被延迟，可以用 nodelay 参数,如：</p> <p><code>limit_req zone=creq burst=5 nodelay;</code></p> <p>这里只是简单讲讲，让大家有这个概念，配置的时候可以深入去找找资料。</p> <h3 id="正向代理"><a href="#正向代理" class="header-anchor">#</a> 正向代理</h3> <p>正向代理，意思是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端才能使用正向代理，比如我们使用的 VPN 服务就是正向代理，直观区别（图片来源于 <a href="https://juejin.im/post/6844903793918738440" target="_blank" rel="noopener noreferrer">前端开发者必备的 Nginx 知识<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）：</p> <p><img src="https://km.woa.com/files/photos/pictures/202106/1623928221_41_w1836_h1778.png" alt="正向代理与方向代理"></p> <p>配置正向代理：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>resolver <span class="token number">8.8</span>.8.8 <span class="token comment"># 谷歌的域名解析地址</span>
server <span class="token punctuation">{</span>
    resolver_timeout 5s<span class="token punctuation">;</span> // 设超时时间
    location / <span class="token punctuation">{</span>
        <span class="token comment"># 当客户端请求我的时候，我会把请求转发给它</span>
        <span class="token comment"># $host 要访问的主机名 $request_uri 请求路径</span>
        proxy_pass http://<span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>正向代理的对象是客户端，服务器端看不到真正的客户端。</p> <h3 id="图片防盗链"><a href="#图片防盗链" class="header-anchor">#</a> 图片防盗链</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>    
    server_name  *.test<span class="token punctuation">;</span>
  
    <span class="token comment"># 图片防盗链</span>
    location ~* <span class="token punctuation">\</span>.<span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>swf<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
        valid_referers none blocked server_names ~<span class="token punctuation">\</span>.google<span class="token punctuation">\</span>. ~<span class="token punctuation">\</span>.baidu<span class="token punctuation">\</span>. *.qq.com<span class="token punctuation">;</span>  <span class="token comment"># 只允许本机 IP 外链引用，将百度和谷歌也加入白名单有利于 SEO</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$invalid_referer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token builtin class-name">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>以上设置就能防止其它网站利用外链访问我们的图片，有利于节省流量</p> <h3 id="适配-pc-或移动设备"><a href="#适配-pc-或移动设备" class="header-anchor">#</a> 适配 PC 或移动设备</h3> <p>根据用户设备不同返回不同样式的站点，以前经常使用的是纯前端的自适应布局，但是复杂的网站并不适合响应式，无论是复杂性和易用性上面还是不如分开编写的好，比如我们常见的淘宝、京东。</p> <p>根据用户请求的 user-agent 来判断是返回 PC 还是 H5 站点：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name test.com<span class="token punctuation">;</span>
  
    location / <span class="token punctuation">{</span>
    	root  /usr/local/app/pc<span class="token punctuation">;</span> <span class="token comment"># pc 的 html 路径</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> ~* <span class="token string">'(Android|webOS|iPhone|iPod|BlackBerry)'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            root /usr/local/app/mobile<span class="token punctuation">;</span> <span class="token comment"># mobile 的 html 路径</span>
        <span class="token punctuation">}</span>
        index index.html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="设置二级域名"><a href="#设置二级域名" class="header-anchor">#</a> 设置二级域名</h3> <p>新建一个 server 即可：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name admin.test.com<span class="token punctuation">;</span> // 二级域名

    location / <span class="token punctuation">{</span>
        root  /usr/local/app/admin<span class="token punctuation">;</span> <span class="token comment"># 二级域名的 html 路径</span>
        index index.html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="配置-https"><a href="#配置-https" class="header-anchor">#</a> 配置 HTTPS</h3> <p>这里我使用的是 certbot 免费证书，但申请一次有效期只有3个月（好像可以用 crontab 尝试配置自动续期，我暂时没试过）：</p> <p>先安装 certbot</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> https://dl.eff.org/certbot-auto
<span class="token function">chmod</span> a+x certbot-auto
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>申请证书（注意：需要把要申请证书的域名先解析到这台服务器上，才能申请）:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sudo</span> ./certbot-auto certonly --standalone --email admin@abc.com -d test.com -d www.test.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行上面指令，按提示操作。</p> <p>Certbot 会启动一个临时服务器来完成验证（会占用 80 端口或 443 端口，因此需要暂时关闭 Web 服务器），然后 Certbot 会把证书以文件的形式保存，包括完整的证书链文件和私钥文件。</p> <p>文件保存在 /etc/letsencrypt/live/ 下面的域名目录下。</p> <p>修改 nginx 配置：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server<span class="token punctuation">{</span>
    listen <span class="token number">443</span> ssl http2<span class="token punctuation">;</span> // 这里还启用了 http/2.0

    ssl_certificate /etc/letsencrypt/live/test.com/fullchain.pem<span class="token punctuation">;</span> <span class="token comment"># 证书文件地址</span>
    ssl_certificate_key /etc/letsencrypt/live/test.com/privkey.pem<span class="token punctuation">;</span> <span class="token comment"># 私钥文件地址</span>

    server_name test.com www.test.com<span class="token punctuation">;</span> // 证书绑定的域名
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="配置-http-转-https"><a href="#配置-http-转-https" class="header-anchor">#</a> 配置 HTTP 转 HTTPS</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
    listen      <span class="token number">80</span><span class="token punctuation">;</span>
    server_name test.com www.test.com<span class="token punctuation">;</span>

    <span class="token comment"># 单域名重定向</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$host</span> <span class="token operator">=</span> <span class="token string">'www.sherlocked93.club'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token builtin class-name">return</span> <span class="token number">301</span> https://www.sherlocked93.club<span class="token variable">$request_uri</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># 全局非 https 协议时重定向</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$scheme</span> <span class="token operator">!=</span> <span class="token string">'https'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin class-name">return</span> <span class="token number">301</span> https://<span class="token variable">$server_name</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># 或者全部重定向</span>
    <span class="token builtin class-name">return</span> <span class="token number">301</span> https://<span class="token variable">$server_name</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>以上配置选择自己需要的一条即可，不用全部加。</p> <h3 id="单页面项目-history-路由配置"><a href="#单页面项目-history-路由配置" class="header-anchor">#</a> 单页面项目 history 路由配置</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  fe.sherlocked93.club<span class="token punctuation">;</span>
  
    location / <span class="token punctuation">{</span>
        root       /usr/local/app/dist<span class="token punctuation">;</span>  <span class="token comment"># vue 打包后的文件夹</span>
        index      index.html index.htm<span class="token punctuation">;</span>
        try_files  <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html @rewrites<span class="token punctuation">;</span> <span class="token comment"># 默认目录下的 index.html，如果都不存在则重定向</span>
  
        expires -1<span class="token punctuation">;</span>                          <span class="token comment"># 首页一般没有强制缓存</span>
        add_header Cache-Control no-cache<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    location @rewrites <span class="token punctuation">{</span> // 重定向设置
        rewrite ^<span class="token punctuation">(</span>.+<span class="token punctuation">)</span>$ /index.html <span class="token builtin class-name">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><a href="https://router.vuejs.org/zh/guide/essentials/history-mode.html#%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E4%BE%8B%E5%AD%90" target="_blank" rel="noopener noreferrer">vue-router<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 官网只有一句话 <code>try_files $uri $uri/ /index.html;</code>，而上面做了一些重定向处理。</p> <h3 id="配置高可用集群-双机热备"><a href="#配置高可用集群-双机热备" class="header-anchor">#</a> 配置高可用集群（双机热备）</h3> <p>当主 nginx 服务器宕机之后，切换到备份的 nginx 服务器</p> <p>首先安装 keepalived:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> keepalived -y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后编辑 <code>/etc/keepalived/keepalived.conf</code> 配置文件，并在配置文件中增加 <code>vrrp_script</code> 定义一个外围检测机制，并在 <code>vrrp_instance</code> 中通过定义 <code>track_script</code> 来追踪脚本执行过程，实现节点转移：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>global_defs<span class="token punctuation">{</span>
   notification_email <span class="token punctuation">{</span>
        cchroot@gmail.com
   <span class="token punctuation">}</span>
   notification_email_from test@firewall.loc
   smtp_server <span class="token number">127.0</span>.0.1
   smtp_connect_timeout <span class="token number">30</span> // 上面都是邮件配置
   router_id LVS_DEVEL     // 当前服务器名字，用 <span class="token function">hostname</span> 命令来查看
<span class="token punctuation">}</span>
vrrp_script chk_maintainace <span class="token punctuation">{</span> // 检测机制的脚本名称为chk_maintainace
    script <span class="token string">&quot;[[ -e/etc/keepalived/down ]] &amp;&amp; exit 1 || exit 0&quot;</span> // 可以是脚本路径或脚本命令
    // script <span class="token string">&quot;/etc/keepalived/nginx_check.sh&quot;</span>    // 比如这样的脚本路径
    interval <span class="token number">2</span>  // 每隔2秒检测一次
    weight -20  // 当脚本执行成立，那么把当前服务器优先级改为-20
<span class="token punctuation">}</span>
vrrp_instanceVI_1 <span class="token punctuation">{</span>   // 每一个vrrp_instance就是定义一个虚拟路由器
    state MASTER      // 主机为MASTER，备用机为BACKUP
    interface eth0    // 网卡名字，可以从ifconfig中查找
    virtual_router_id <span class="token number">51</span> // 虚拟路由的id号，一般小于255，主备机id需要一样
    priority <span class="token number">100</span>      // 优先级，master的优先级比backup的大
    advert_int <span class="token number">1</span>      // 默认心跳间隔
    authentication <span class="token punctuation">{</span>  // 认证机制
        auth_type PASS
        auth_pass <span class="token number">1111</span>   // 密码
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>  // 虚拟地址vip
       <span class="token number">172.16</span>.2.8
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>其中检测脚本 <code>nginx_check.sh</code>，这里提供一个：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">A</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx --no-header <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$A</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
    /usr/sbin/nginx <span class="token comment"># 尝试重新启动nginx</span>
    <span class="token function">sleep</span> <span class="token number">2</span>         <span class="token comment"># 睡眠2秒</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx --no-header <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">`</span></span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token function">killall</span> keepalived <span class="token comment"># 启动失败，将keepalived服务杀死。将vip漂移到其它备份节点</span>
    <span class="token keyword">fi</span>
<span class="token keyword">fi</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>复制一份到备份服务器，备份 nginx 的配置要将 <code>state</code> 后改为 <code>BACKUP</code>，<code>priority</code> 改为比主机小。
设置完毕后各自 <code>service keepalived start</code> 启动，经过访问成功之后，可以把 Master 机的 keepalived 停掉，此时 Master 机就不再是主机了 <code>service keepalived stop</code>，看访问虚拟 IP 时是否能够自动切换到备机 ip addr。</p> <p>再次启动 Master 的 keepalived，此时 vip 又变到了主机上。</p> <p>配置高可用集群的内容来源于：<a href="https://juejin.im/post/6844904144235413512#heading-11" target="_blank" rel="noopener noreferrer">Nginx 从入门到实践，万字详解！<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="其它功能和技巧"><a href="#其它功能和技巧" class="header-anchor">#</a> 其它功能和技巧</h2> <h3 id="代理缓存"><a href="#代理缓存" class="header-anchor">#</a> 代理缓存</h3> <p>nginx 的 http_proxy 模块，提供类似于 Squid 的缓存功能，使用 proxy_cache_path 来配置。</p> <p>nginx 可以对访问过的内容在 nginx 服务器本地建立副本，这样在一段时间内再次访问该数据，就不需要通过 nginx 服务器再次向后端服务器发出请求，减小数据传输延迟，提高访问速度：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>proxy_cache_path usr/local/cache levels=1:2 keys_zone=my_cache:10m;

server {
  listen       80;
  server_name  test.com;

  location / {
      proxy_cache my_cache;
      proxy_pass http://127.0.0.1:8888;
      proxy_set_header Host $host;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>上面的配置表示： nginx 提供一块 10 M 的内存用于缓存，名字为 my_cache, levels 等级为 1:2，缓存存放的路径为 <code>usr/local/cache</code>。</p> <h3 id="访问日志"><a href="#访问日志" class="header-anchor">#</a> 访问日志</h3> <p>访问日志默认是注释的状态，需要可以打开和进行更详细的配置，一下是 nginx 的默认配置：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>http <span class="token punctuation">{</span>
    log_format  main  <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local</span>] &quot;<span class="token variable">$request</span>&quot; '</span>
                      <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> &quot;<span class="token variable">$http_referer</span>&quot; '</span>
                      <span class="token string">'&quot;<span class="token variable">$http_user_agent</span>&quot; &quot;<span class="token variable">$http_x_forwarded_for</span>&quot;'</span><span class="token punctuation">;</span>

    access_log  logs/access.log  main<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="错误日志"><a href="#错误日志" class="header-anchor">#</a> 错误日志</h3> <p>错误日志放在 main 全局区块中，童鞋们打开 nginx.conf 就可以看见在配置文件中和下面一样的代码了：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#error_log  logs/error.log;</span>
<span class="token comment">#error_log  logs/error.log  notice;</span>
<span class="token comment">#error_log  logs/error.log  info;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>nginx 错误日志默认配置为：</p> <p><code>error_log logs/error.log error;</code></p> <h3 id="静态资源服务器"><a href="#静态资源服务器" class="header-anchor">#</a> 静态资源服务器</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
    listen       80;
    server_name  static.bin;
    charset utf-8;    # 防止中文文件名乱码

    location /download {
        alias	          /usr/share/nginx/static;  # 静态资源目录
  
        autoindex               on;    # 开启静态资源列目录，浏览目录权限
        autoindex_exact_size    off;   # on(默认)显示文件的确切大小，单位是byte；off显示文件大概大小，单位KB、MB、GB
        autoindex_localtime     off;   # off(默认)时显示的文件时间为GMT时间；on显示的文件时间为服务器时间
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="禁止指定-user-agent"><a href="#禁止指定-user-agent" class="header-anchor">#</a> 禁止指定 user_agent</h3> <p>nginx 可以禁止指定的浏览器和爬虫框架访问：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># http_user_agent 为浏览器标识</span>
<span class="token comment"># 禁止 user_agent 为baidu、360和sohu，~*表示不区分大小写匹配</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> ~* <span class="token string">'baidu|360|sohu'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">return</span> <span class="token number">404</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment"># 禁止 Scrapy 等工具的抓取</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> ~* <span class="token punctuation">(</span>Scrapy<span class="token operator">|</span>Curl<span class="token operator">|</span>HttpClient<span class="token punctuation">))</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="请求过滤"><a href="#请求过滤" class="header-anchor">#</a> 请求过滤</h3> <p><strong>根据请求类型过滤</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 非指定请求全返回 403</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$request_method</span> <span class="token operator">!</span>~ ^<span class="token punctuation">(</span>GET<span class="token operator">|</span>POST<span class="token operator">|</span>HEAD<span class="token punctuation">)</span>$ <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>根据状态码过滤</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error_page <span class="token number">502</span> <span class="token number">503</span> /50x.html<span class="token punctuation">;</span>
location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
    root /usr/share/nginx/html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这样实际上是一个内部跳转，当访问出现 502、503 的时候就能返回 50x.html 中的内容，这里需要注意是否可以找到 50x.html 页面，所以加了个 location 保证找到你自定义的 50x 页面。</p> <p><strong>根据URL名称过滤</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$host</span> <span class="token operator">=</span> zy.com' <span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">#其中$1是取自regex部分()里的内容,匹配成功后跳转到的URL。</span>
     rewrite ^/<span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$  http://www.zy.com/<span class="token variable">$1</span>  permanent；
<span class="token punctuation">}</span>

location /test <span class="token punctuation">{</span>
    // /test 全部重定向到首页
    rewrite  ^<span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$ /index.html  redirect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="ab-命令"><a href="#ab-命令" class="header-anchor">#</a> ab 命令</h3> <p>ab命令全称为：Apache bench，是 Apache 自带的压力测试工具，也可以测试 Nginx、IIS 等其他 Web 服务器:</p> <ul><li>-n 总共的请求数</li> <li>-c 并发的请求数</li> <li>-t 测试所进行的最大秒数，默认值 为 50000</li> <li>-p 包含了需要的 POST 的数据文件</li> <li>-T POST数据所使用的 Content-type 头信息</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>ab -n <span class="token number">1000</span> -c <span class="token number">5000</span> http://127.0.0.1/ <span class="token comment"># 每次发送1000并发的请求数，请求数总数为5000。 </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>测试前需要安装 httpd-tools： <code>yum install httpd-tools</code></p> <h3 id="泛域名路径分离"><a href="#泛域名路径分离" class="header-anchor">#</a> 泛域名路径分离</h3> <p>这是一个非常实用的技能，经常有时候我们可能需要配置一些二级或者三级域名，希望通过 nginx 自动指向对应目录，比如：</p> <ol><li>test1.doc.test.club 自动指向 /usr/local/html/doc/test1 服务器地址；</li> <li>test2.doc.test.club 自动指向 /usr/local/html/doc/test2 服务器地址；</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  ~^<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">\</span>w-<span class="token punctuation">]</span>+<span class="token punctuation">)</span><span class="token punctuation">\</span>.doc<span class="token punctuation">\</span>.test<span class="token punctuation">\</span>.club$<span class="token punctuation">;</span>

    root /usr/local/html/doc/<span class="token variable">$1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="泛域名转发"><a href="#泛域名转发" class="header-anchor">#</a> 泛域名转发</h3> <p>和之前的功能类似，有时候我们希望把二级或者三级域名链接重写到我们希望的路径，让后端就可以根据路由解析不同的规则：</p> <ol><li>test1.serv.test.club/api?name=a 自动转发到 127.0.0.1:8080/test1/api?name=a</li> <li>test2.serv.test.club/api?name=a 自动转发到 127.0.0.1:8080/test2/api?name=a</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name ~^<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">\</span>w-<span class="token punctuation">]</span>+<span class="token punctuation">)</span><span class="token punctuation">\</span>.serv<span class="token punctuation">\</span>.test<span class="token punctuation">\</span>.club$<span class="token punctuation">;</span>

    location / <span class="token punctuation">{</span>
        proxy_set_header        X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
        proxy_set_header        X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
        proxy_set_header        Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
        proxy_set_header        X-NginX-Proxy <span class="token boolean">true</span><span class="token punctuation">;</span>
        proxy_pass              http://127.0.0.1:8080/<span class="token variable">$1</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h2> <h3 id="nginx-中怎么设置变量"><a href="#nginx-中怎么设置变量" class="header-anchor">#</a> nginx  中怎么设置变量</h3> <p>或许你不知道，nginx 的配置文件使用的是一门微型的编程语言。既然是编程语言，一般也就少不了“变量”这种东西，但是在 nginx 配置中，变量只能存放一种类型的值，因为也只存在一种类型的值，那就是字符串。</p> <p>例如我们在 nginx.conf 中有这样一行配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>set $name &quot;chroot&quot;;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上面使用了 set 配置指令对变量 <code>$name</code>进行了赋值操作，把 &quot;chroot&quot; 赋值给了 <code>$name</code>。nginx 变量名前面有一个  <code>$</code> 符号，这是记法上的要求。所有的 Nginx 变量在 Nginx 配置文件中引用时都须带上 <code>$</code> 前缀。这种表示方法和 Perl、PHP 这些语言是相似的。</p> <p>这种表示方法的用处在哪里呢，那就是可以直接把变量嵌入到字符串常量中以构造出新的字符串，例如你需要进行一个字符串拼接：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
  listen       80;
  server_name  test.com;

  location / {
     set $temp hello;
     return &quot;$temp world&quot;;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>以上当匹配成功的时候就会返回字符串 &quot;hello world&quot; 了。需要注意的是，当引用的变量名之后紧跟着变量名的构成字符时（比如后跟字母、数字以及下划线），我们就需要使用特别的记法来消除歧义，例如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
  listen       80;
  server_name  test.com;

  location / {
     set $temp &quot;hello &quot;;
     return &quot;${temp}world&quot;;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这里，我们在配置指令的参数值中引用变量 <code>$temp</code> 的时候，后面紧跟着 <code>world</code> 这个单词，所以如果直接写作 <code>&quot;$tempworld&quot;</code> 则 nginx 的计算引擎会将之识别为引用了变量 <code>$tempworld</code>. 为了解决这个问题，nginx 的字符串支持使用花括号在 <code>$</code> 之后把变量名围起来，比如这里的 <code>${temp}</code>，所以 上面这个例子返回的还是 &quot;hello world&quot;：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ curl 'http://test.com/'
    hello world
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>还需要注意的是，若是想输出 <code>$</code> 符号本身，可以这样做：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>geo $dollar {
    default &quot;$&quot;;
}
server {
    listen       80;
    server_name  test.com;

    location / {
        set $temp &quot;hello &quot;;
        return &quot;${temp}world: $dollar&quot;;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>上面用到了标准模块 ngx_geo 提供的配置指令 geo 来为变量 <code>$dollar</code> 赋予字符串 <code>&quot;$&quot;</code> ，这样，这里的返回值就是 &quot;hello world:  $&quot; 了。</p> <h2 id="附-nginx-内置预定义变量"><a href="#附-nginx-内置预定义变量" class="header-anchor">#</a> 附 nginx 内置预定义变量</h2> <p>按字母顺序：</p> <table><thead><tr><th>变量名</th> <th>定义</th></tr></thead> <tbody><tr><td>$arg_PARAMETER</td> <td>GET 请求中变量名 PARAMETER 参数的值</td></tr> <tr><td>$args</td> <td>这个变量等于 GET 请求中的参数，例如，foo=123&amp;bar=blahblah;这个变量只可以被修改</td></tr> <tr><td>$binary_remote_addr</td> <td>二进制码形式的客户端地址</td></tr> <tr><td>$body_bytes_sent</td> <td>传送页面的字节数</td></tr> <tr><td>$content_length</td> <td>请求头中的 Content-length 字段</td></tr> <tr><td>$content_type</td> <td>请求头中的 Content-Type 字段</td></tr> <tr><td>$cookie_COOKIE</td> <td>cookie COOKIE 的值</td></tr> <tr><td>$document_root</td> <td>当前请求在 root 指令中指定的值</td></tr> <tr><td>$document_uri</td> <td>与 $uri 相同</td></tr> <tr><td>$host</td> <td>请求中的主机头(Host)字段，如果请求中的主机头不可用或者空，则为处理请求的 server 名称(处理请求的 server 的 server_name 指令的值)。值为小写，不包含端口。</td></tr> <tr><td>$hostname</td> <td>机器名使用 gethostname 系统调用的值</td></tr> <tr><td>$http_HEADER</td> <td>HTTP 请求头中的内容，HEADER 为 HTTP 请求中的内容转为小写，-变为_(破折号变为下划线)，例如：$http_user_agent(Uaer-Agent 的值)</td></tr> <tr><td>$sent_http_HEADER</td> <td>HTTP 响应头中的内容，HEADER 为 HTTP 响应中的内容转为小写，-变为_(破折号变为下划线)，例如：<code>$</code>sent_http_cache_control、<code>$</code>sent_http_content_type…</td></tr> <tr><td>$is_args</td> <td>如果 $args 设置，值为&quot;?&quot;，否则为&quot;&quot;</td></tr> <tr><td>$limit_rate</td> <td>这个变量可以限制连接速率</td></tr> <tr><td>$nginx_version</td> <td>当前运行的 nginx 版本号</td></tr> <tr><td>$query_string</td> <td>与 $args 相同</td></tr> <tr><td>$remote_addr</td> <td>客户端的IP地址</td></tr> <tr><td>$remote_port</td> <td>客户端的端口</td></tr> <tr><td>$remote_port</td> <td>已经经过 Auth Basic Module 验证的用户名</td></tr> <tr><td>$request_filename</td> <td>当前连接请求的文件路径，由 root 或 alias 指令与 URI 请求生成</td></tr> <tr><td>$request_body</td> <td>这个变量（0.7.58+）包含请求的主要信息。在使用 proxy_pass 或 fastcgi_pass 指令的 location 中比较有意义</td></tr> <tr><td>$request_body_file</td> <td>客户端请求主体信息的临时文件名</td></tr> <tr><td>$request_completion</td> <td>如果请求成功，设为&quot;OK&quot;；如果请求未完成或者不是一系列请求中最后一部分则设为空</td></tr> <tr><td>$request_method</td> <td>这个变量是客户端请求的动作，通常为 GET 或 POST。包括 0.8.20 及之前的版本中，这个变量总为 main request 中的动作，如果当前请求是一个子请求，并不使用这个当前请求的动作</td></tr> <tr><td>$request_uri</td> <td>这个变量等于包含一些客户端请求参数的原始 URI，它无法修改，请查看 $uri 更改或重写 URI</td></tr> <tr><td>$scheme</td> <td>所用的协议，例如 http 或者是 https，例如 rewrite ^(.+)$ $scheme://example.com$1 redirect</td></tr> <tr><td>$server_addr</td> <td>服务器地址，在完成一次系统调用后可以确定这个值，如果要绕开系统调用，则必须在listen中指定地址并且使用bind参数</td></tr> <tr><td>$server_name</td> <td>服务器名称</td></tr> <tr><td>$server_port</td> <td>请求到达服务器的端口号</td></tr> <tr><td>$server_protocol</td> <td>请求使用的协议，通常是 HTTP/1.0、HTTP/1.1或HTTP/2</td></tr> <tr><td>$uri</td> <td>请求中的当前 URI(不带请求参数，参数位于 args ) ， 不 同 于 浏 览 器 传 递 的 args)，不同于浏览器传递的 args)，不同于浏览器传递的 request_uri 的值，它可以通过内部重定向，或者使用 index 指令进行修改。不包括协议和主机名，例如 /foo/bar.html</td></tr></tbody></table> <h2 id="附-nginx-模块"><a href="#附-nginx-模块" class="header-anchor">#</a> 附 nginx 模块</h2> <h3 id="nginx-模块分类"><a href="#nginx-模块分类" class="header-anchor">#</a> nginx 模块分类</h3> <ul><li>核心模块：nginx 最基本最核心的服务，如进程管理、权限控制、日志记录；</li> <li>标准 HTTP 模块：nginx 服务器的标准 HTTP 功能；</li> <li>可选 HTTP 模块：处理特殊的 HTTP 请求</li> <li>邮件服务模块：邮件服务</li> <li>第三方模块：作为扩展，完成特殊功能</li></ul> <h3 id="模块清单"><a href="#模块清单" class="header-anchor">#</a> 模块清单</h3> <p><strong>核心模块</strong>：</p> <ul><li>ngx_core</li> <li>ngx_errlog</li> <li>ngx_conf</li> <li>ngx_events</li> <li>ngx_event_core</li> <li>ngx_epll</li> <li>ngx_regex</li></ul> <p><strong>标准 HTTP 模块</strong>：</p> <ul><li>ngx_http</li> <li>ngx_http_core             #配置端口，URI 分析，服务器相应错误处理，别名控制 (alias) 等</li> <li>ngx_http_log              #自定义 access 日志</li> <li>ngx_http_upstream         #定义一组服务器，可以接受来自 proxy, Fastcgi,Memcache 的重定向；主要用作负载均衡</li> <li>ngx_http_static</li> <li>ngx_http_autoindex        #自动生成目录列表</li> <li>ngx_http_index            #处理以/结尾的请求，如果没有找到 index 页，则看是否开启了random_index；如开启，则用之，否则用 autoindex</li> <li>ngx_http_auth_basic       #基于 http 的身份认证 (auth_basic)</li> <li>ngx_http_access           #基于 IP 地址的访问控制 (deny,allow)</li> <li>ngx_http_limit_conn       #限制来自客户端的连接的响应和处理速率</li> <li>ngx_http_limit_req        #限制来自客户端的请求的响应和处理速率</li> <li>ngx_http_geo</li> <li>ngx_http_map              #创建任意的键值对变量</li> <li>ngx_http_split_clients</li> <li>ngx_http_referer          #过滤 HTTP 头中 Referer 为空的对象</li> <li>ngx_http_rewrite          #通过正则表达式重定向请求</li> <li>ngx_http_proxy</li> <li>ngx_http_fastcgi          #支持 fastcgi</li> <li>ngx_http_uwsgi</li> <li>ngx_http_scgi</li> <li>ngx_http_memcached</li> <li>ngx_http_empty_gif        #从内存创建一个 1×1 的透明 gif 图片，可以快速调用</li> <li>ngx_http_browser          #解析 http 请求头部的 User-Agent 值</li> <li>ngx_http_charset          #指定网页编码</li> <li>ngx_http_upstream_ip_hash</li> <li>ngx_http_upstream_least_conn</li> <li>ngx_http_upstream_keepalive</li> <li>ngx_http_write_filter</li> <li>ngx_http_header_filter</li> <li>ngx_http_chunked_filter</li> <li>ngx_http_range_header</li> <li>ngx_http_gzip_filter</li> <li>ngx_http_postpone_filter</li> <li>ngx_http_ssi_filter</li> <li>ngx_http_charset_filter</li> <li>ngx_http_userid_filter</li> <li>ngx_http_headers_filter   #设置 http 响应头</li> <li>ngx_http_copy_filter</li> <li>ngx_http_range_body_filter</li> <li>ngx_http_not_modified_filter</li></ul> <p><strong>可选 HTTP 模块</strong>:</p> <ul><li>ngx_http_addition #在响应请求的页面开始或者结尾添加文本信息</li> <li>ngx_http_degradation      #在低内存的情况下允许服务器返回 444 或者 204 错误</li> <li>ngx_http_perl</li> <li>ngx_http_flv              #支持将 Flash 多媒体信息按照流文件传输，可以根据客户端指定的开始位置返回 Flash</li> <li>ngx_http_geoip            #支持解析基于 GeoIP 数据库的客户端请求</li> <li>ngx_google_perftools</li> <li>ngx_http_gzip             #gzip 压缩请求的响应</li> <li>ngx_http_gzip_static      #搜索并使用预压缩的以.gz 为后缀的文件代替一般文件响应客户端请求</li> <li>ngx_http_image_filter     #支持改变 png，jpeg，gif 图片的尺寸和旋转方向</li> <li>ngx_http_mp4              #支持.mp4,.m4v,.m4a 等多媒体信息按照流文件传输，常与 ngx_http_flv 一起使用</li> <li>ngx_http_random_index     #当收到 / 结尾的请求时，在指定目录下随机选择一个文件作为 index</li> <li>ngx_http_secure_link      #支持对请求链接的有效性检查</li> <li>ngx_http_ssl              #支持 https</li> <li>ngx_http_stub_status</li> <li>ngx_http_sub_module       #使用指定的字符串替换响应中的信息</li> <li>ngx_http_dav              #支持 HTTP 和 WebDAV 协议中的 PUT/DELETE/MKCOL/COPY/MOVE 方法</li> <li>ngx_http_xslt             #将 XML 响应信息使用 XSLT 进行转换</li></ul> <p><strong>邮件服务模块</strong>:</p> <ul><li>ngx_mail_core</li> <li>ngx_mail_pop3</li> <li>ngx_mail_imap</li> <li>ngx_mail_smtp</li> <li>ngx_mail_auth_http</li> <li>ngx_mail_proxy</li> <li>ngx_mail_ssl</li></ul> <p><strong>第三方模块</strong>：</p> <ul><li>echo-nginx-module         #支持在 nginx 配置文件中使用 echo/sleep/time/exec 等类 Shell 命令</li> <li>memc-nginx-module</li> <li>rds-json-nginx-module     #使 nginx 支持 json 数据的处理</li> <li>lua-nginx-module</li></ul> <p>感谢阅读~</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/interview/pages/interview notes/Webpack 性能优化.html" class="prev">
        Webpack 性能优化
      </a></span> <span class="next"><a href="/interview/pages/interview notes/一篇文章入门 redis（万字长文干货）.html">
        一篇文章入门 redis（万字长文干货）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/interview/assets/js/app.315fcd90.js" defer></script><script src="/interview/assets/js/3.2951d97b.js" defer></script><script src="/interview/assets/js/30.80f06240.js" defer></script>
  </body>
</html>
