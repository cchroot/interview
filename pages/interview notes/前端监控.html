<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端监控 | 小墨鱼的面试笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/interview/egg.png">
    <meta name="description" content="小墨鱼的面试笔记">
    
    <link rel="preload" href="/interview/assets/css/0.styles.41202823.css" as="style"><link rel="preload" href="/interview/assets/js/app.315fcd90.js" as="script"><link rel="preload" href="/interview/assets/js/3.2951d97b.js" as="script"><link rel="preload" href="/interview/assets/js/37.1834af1c.js" as="script"><link rel="prefetch" href="/interview/assets/js/10.7ffca870.js"><link rel="prefetch" href="/interview/assets/js/11.a796a1e1.js"><link rel="prefetch" href="/interview/assets/js/12.c1a92f5b.js"><link rel="prefetch" href="/interview/assets/js/13.e23fb603.js"><link rel="prefetch" href="/interview/assets/js/14.6fe10376.js"><link rel="prefetch" href="/interview/assets/js/15.39fcb4a0.js"><link rel="prefetch" href="/interview/assets/js/16.a28d5ced.js"><link rel="prefetch" href="/interview/assets/js/17.a2ae2507.js"><link rel="prefetch" href="/interview/assets/js/18.f4d5c0b7.js"><link rel="prefetch" href="/interview/assets/js/19.9675a5ad.js"><link rel="prefetch" href="/interview/assets/js/2.51e9aef8.js"><link rel="prefetch" href="/interview/assets/js/20.eff5de6d.js"><link rel="prefetch" href="/interview/assets/js/21.39b07448.js"><link rel="prefetch" href="/interview/assets/js/22.2526b024.js"><link rel="prefetch" href="/interview/assets/js/23.e582a7d7.js"><link rel="prefetch" href="/interview/assets/js/24.6fab991d.js"><link rel="prefetch" href="/interview/assets/js/25.a11720bf.js"><link rel="prefetch" href="/interview/assets/js/26.ad35af4b.js"><link rel="prefetch" href="/interview/assets/js/27.a807c0ff.js"><link rel="prefetch" href="/interview/assets/js/28.43ec09a9.js"><link rel="prefetch" href="/interview/assets/js/29.40a4c8d6.js"><link rel="prefetch" href="/interview/assets/js/30.80f06240.js"><link rel="prefetch" href="/interview/assets/js/31.e254c535.js"><link rel="prefetch" href="/interview/assets/js/32.becfed3a.js"><link rel="prefetch" href="/interview/assets/js/33.169d624d.js"><link rel="prefetch" href="/interview/assets/js/34.e75ce0f2.js"><link rel="prefetch" href="/interview/assets/js/35.cfd2a91d.js"><link rel="prefetch" href="/interview/assets/js/36.813fc716.js"><link rel="prefetch" href="/interview/assets/js/38.b3a019c6.js"><link rel="prefetch" href="/interview/assets/js/39.c64b6de1.js"><link rel="prefetch" href="/interview/assets/js/4.4edc6fe1.js"><link rel="prefetch" href="/interview/assets/js/40.20696ba5.js"><link rel="prefetch" href="/interview/assets/js/41.364a730f.js"><link rel="prefetch" href="/interview/assets/js/42.ee2aef05.js"><link rel="prefetch" href="/interview/assets/js/43.752ba15f.js"><link rel="prefetch" href="/interview/assets/js/44.667525a3.js"><link rel="prefetch" href="/interview/assets/js/45.b2834a73.js"><link rel="prefetch" href="/interview/assets/js/46.f874b150.js"><link rel="prefetch" href="/interview/assets/js/47.b7dd2d1e.js"><link rel="prefetch" href="/interview/assets/js/48.0b79ef3e.js"><link rel="prefetch" href="/interview/assets/js/49.bb77babc.js"><link rel="prefetch" href="/interview/assets/js/5.5f1bafd5.js"><link rel="prefetch" href="/interview/assets/js/50.66c1fd87.js"><link rel="prefetch" href="/interview/assets/js/51.15241f09.js"><link rel="prefetch" href="/interview/assets/js/52.0d2383ca.js"><link rel="prefetch" href="/interview/assets/js/53.439b2bec.js"><link rel="prefetch" href="/interview/assets/js/6.8b1e859e.js"><link rel="prefetch" href="/interview/assets/js/7.2e1d4b27.js"><link rel="prefetch" href="/interview/assets/js/8.06e19e8e.js"><link rel="prefetch" href="/interview/assets/js/9.98b67c20.js">
    <link rel="stylesheet" href="/interview/assets/css/0.styles.41202823.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/interview/" class="home-link router-link-active"><img src="/interview/egg.png" alt="小墨鱼的面试笔记" class="logo"> <span class="site-name can-hide">小墨鱼的面试笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/interview/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/interview/pages/interview notes/JS 基础知识点.html" class="nav-link">
  面试笔记
</a></div><div class="nav-item"><a href="/interview/pages/interview questions/js基础面试题.html" class="nav-link">
  精选面试题
</a></div><div class="nav-item"><a href="https://github.com/cchroot/interview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/interview/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/interview/pages/interview notes/JS 基础知识点.html" class="nav-link">
  面试笔记
</a></div><div class="nav-item"><a href="/interview/pages/interview questions/js基础面试题.html" class="nav-link">
  精选面试题
</a></div><div class="nav-item"><a href="https://github.com/cchroot/interview" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/JS 基础知识点.html" class="sidebar-link">基础知识点</a></li><li><a href="/interview/pages/interview notes/JS 进阶知识点.html" class="sidebar-link">JS 进阶知识点</a></li><li><a href="/interview/pages/interview notes/JS 异步编程.html" class="sidebar-link">异步编程</a></li><li><a href="/interview/pages/interview notes/浏览器与Node的事件循环Event Loop.html" class="sidebar-link">浏览器与Node的事件循环(Event Loop)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JS手写相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/JS 手写相关.html" class="sidebar-link">JS 手写大全</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/性能优化总结.html" class="sidebar-link">性能优化总结</a></li><li><a href="/interview/pages/interview notes/网络协议相关优化.html" class="sidebar-link">网络协议相关优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>浏览器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/浏览器基础知识点.html" class="sidebar-link">浏览器基础知识点</a></li><li><a href="/interview/pages/interview notes/浏览器缓存机制.html" class="sidebar-link">浏览器缓存机制</a></li><li><a href="/interview/pages/interview notes/浏览器渲染原理.html" class="sidebar-link">浏览器渲染原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTTP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/http.html" class="sidebar-link">HTTP知识整合</a></li><li><a href="/interview/pages/interview notes/从输入url到页面展示到底发生了什么.html" class="sidebar-link">从输入url到页面展示到底发生了什么</a></li><li><a href="/interview/pages/interview notes/从输入url开始能做哪些优化.html" class="sidebar-link">从输入url开始能做哪些优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>安全</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/安全防范知识点.html" class="sidebar-link">安全防范知识点</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>监控</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/前端监控.html" class="active sidebar-link">前端监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/前端监控.html#前端性能监控" class="sidebar-link">前端性能监控</a></li><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/前端监控.html#前端错误监控" class="sidebar-link">前端错误监控</a></li><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/前端监控.html#页面埋点" class="sidebar-link">页面埋点</a></li><li class="sidebar-sub-header"><a href="/interview/pages/interview notes/前端监控.html#开源的解决方案" class="sidebar-link">开源的解决方案</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue And React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/你能实现一个没有漏洞的双向绑定吗.html" class="sidebar-link">你能实现一个没有漏洞的双向绑定吗</a></li><li><a href="/interview/pages/interview notes/vue源码阅读笔记.html" class="sidebar-link">vue源码阅读笔记</a></li><li><a href="/interview/pages/interview notes/vueRouter源码阅读笔记.html" class="sidebar-link">vueRouter源码阅读笔记</a></li><li><a href="/interview/pages/interview notes/vuex源码阅读笔记.html" class="sidebar-link">vuex源码阅读笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/Webpack 性能优化.html" class="sidebar-link">Webpack 性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>nginx</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/nginx.html" class="sidebar-link">nginx 操作总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/一篇文章入门 redis（万字长文干货）.html" class="sidebar-link">一篇文章入门 redis（万字长文干货）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其它</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/pages/interview notes/一篇文章搞定 javascript 正则表达式.html" class="sidebar-link">一篇文章搞定 javascript 正则表达式</a></li><li><a href="/interview/pages/interview notes/interview.html" class="sidebar-link">很久很久以前的面试复习一</a></li><li><a href="/interview/pages/interview notes/interview2.html" class="sidebar-link">很久很久以前的面试复习二</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="前端监控"><a href="#前端监控" class="header-anchor">#</a> 前端监控</h1> <h2 id="前端性能监控"><a href="#前端性能监控" class="header-anchor">#</a> 前端性能监控</h2> <p>利用 performance API <code>let timing = performance.getEntriesByType('navigation')[0];</code> 或者 <code>let timing = performance.timing</code>。封装一个函数，在页面加载完毕后执行，做了一些各个阶段性能指标的计算，然后通过接口发送到服务器，用于统计判断。</p> <p>在 Console 中输入 <code>performance.getEntriesByType('navigation')[0]</code>：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>connectEnd: 9.225000045262277
connectStart: 9.225000045262277
decodedBodySize: 113880
domComplete: 1361.1650000093505
domContentLoadedEventEnd: 522.205000044778
domContentLoadedEventStart: 522.1950000268407
domInteractive: 223.31999999005347
domainLookupEnd: 9.225000045262277
domainLookupStart: 9.225000045262277
duration: 1361.4700000034645
encodedBodySize: 23636
entryType: &quot;navigation&quot;
fetchStart: 9.225000045262277
initiatorType: &quot;navigation&quot;
loadEventEnd: 1361.4700000034645
loadEventStart: 1361.3600000389852
name: &quot;https://juejin.cn/post/6844903540385644557&quot;
nextHopProtocol: &quot;h2&quot;
redirectCount: 0
redirectEnd: 0
redirectStart: 0
requestStart: 12.350000033620745
responseEnd: 204.4350000214763
responseStart: 155.64000001177192
secureConnectionStart: 9.225000045262277
serverTiming: (3) [PerformanceServerTiming, PerformanceServerTiming, PerformanceServerTiming]
startTime: 0
transferSize: 24222
type: &quot;navigate&quot;
unloadEventEnd: 0
unloadEventStart: 0
workerStart: 0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>输入 <code>performance.timing</code> 可以得到：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connectEnd<span class="token operator">:</span> <span class="token number">1608797959509</span>
connectStart<span class="token operator">:</span> <span class="token number">1608797959509</span>
domComplete<span class="token operator">:</span> <span class="token number">1608797960861</span>
domContentLoadedEventEnd<span class="token operator">:</span> <span class="token number">1608797960022</span>
domContentLoadedEventStart<span class="token operator">:</span> <span class="token number">1608797960022</span>
domInteractive<span class="token operator">:</span> <span class="token number">1608797959723</span>
domLoading<span class="token operator">:</span> <span class="token number">1608797959663</span>
domainLookupEnd<span class="token operator">:</span> <span class="token number">1608797959509</span>
domainLookupStart<span class="token operator">:</span> <span class="token number">1608797959509</span>
fetchStart<span class="token operator">:</span> <span class="token number">1608797959509</span>
loadEventEnd<span class="token operator">:</span> <span class="token number">1608797960862</span>
loadEventStart<span class="token operator">:</span> <span class="token number">1608797960861</span>
navigationStart<span class="token operator">:</span> <span class="token number">1608797959501</span>
redirectEnd<span class="token operator">:</span> <span class="token number">0</span>
redirectStart<span class="token operator">:</span> <span class="token number">0</span>
requestStart<span class="token operator">:</span> <span class="token number">1608797959512</span>
responseEnd<span class="token operator">:</span> <span class="token number">1608797959705</span>
responseStart<span class="token operator">:</span> <span class="token number">1608797959656</span>
secureConnectionStart<span class="token operator">:</span> <span class="token number">0</span>
unloadEventEnd<span class="token operator">:</span> <span class="token number">0</span>
unloadEventStart<span class="token operator">:</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>计算一些关键的性能指标</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Time to Interactive</span>
    <span class="token keyword">let</span> timing <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByType</span><span class="token punctuation">(</span><span class="token string">'navigation'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// let timing = performance.timing</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>timing<span class="token punctuation">.</span>domInteractive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>timing<span class="token punctuation">.</span>fetchStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> diff <span class="token operator">=</span> timing<span class="token punctuation">.</span>domInteractive <span class="token operator">-</span> timing<span class="token punctuation">.</span>fetchStart<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;TTI: &quot;</span> <span class="token operator">+</span> diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>以上代码只测量了&quot;首次可交互时间&quot;，其它常用的性能指标还有：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DNS 解析耗时: domainLookupEnd - domainLookupStart
TCP 连接耗时: connectEnd - connectStart
SSL 安全连接耗时: connectEnd - secureConnectionStart
网络请求耗时 (TTFB): responseStart - requestStart
数据传输耗时: responseEnd - responseStart
DOM 解析耗时: domInteractive - responseEnd
资源加载耗时: loadEventStart - domContentLoadedEventEnd
First Byte时间: responseStart - domainLookupStart
白屏时间: responseEnd - fetchStart
首次可交互时间: domInteractive - fetchStart
DOM Ready 时间: domContentLoadEventEnd - fetchStart
页面完全加载时间: loadEventStart - fetchStart
http 头部大小： transferSize - encodedBodySize
重定向次数：performance.navigation.redirectCount
重定向耗时: redirectEnd - redirectStart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>利用 <code>let timing = performance.getEntriesByType('navigation')[0];</code> 或者 <code>let timing = performance.timing</code> 计算结果是基本一致的。</p> <h2 id="前端错误监控"><a href="#前端错误监控" class="header-anchor">#</a> 前端错误监控</h2> <h3 id="前端错误的分类"><a href="#前端错误的分类" class="header-anchor">#</a> 前端错误的分类</h3> <ul><li><p>即时运行错误（代码错误）</p></li> <li><p>资源加载错误</p></li></ul> <h3 id="即时运行错误捕获方式"><a href="#即时运行错误捕获方式" class="header-anchor">#</a> 即时运行错误捕获方式</h3> <h4 id="全局捕获"><a href="#全局捕获" class="header-anchor">#</a> 全局捕获</h4> <p>对于代码运行错误，通常的办法是使用 <code>window.onerror</code> 或者 addEventListener 拦截报错：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">errorMessage<span class="token punctuation">,</span> scriptURI<span class="token punctuation">,</span> lineNo<span class="token punctuation">,</span> columnNo<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'errorMessage: '</span> <span class="token operator">+</span> errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常信息</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scriptURI: '</span> <span class="token operator">+</span> scriptURI<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常文件路径</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'lineNo: '</span> <span class="token operator">+</span> lineNo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常行号</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'columnNo: '</span> <span class="token operator">+</span> columnNo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常列号</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error: '</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常堆栈信息</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// 异常上报</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'这是一个错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// 异常上报</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'这是一个错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>通过 <code>window.onerror</code> 事件，可以得到具体的异常信息、异常文件的URL、异常的行号与列号及异常的堆栈信息，再捕获异常后，统一上报至我们的日志服务器。</p> <p>该方法能拦截到大部分的详细报错信息，但是也有例外：</p> <ul><li>对于跨域的代码运行错误会显示 Script error. 对于这种情况我们需要给 script 标签添加 crossorigin=&quot;anonymous&quot; 属性，或后端配置 Access-Control-Allow-Origin</li> <li>对于某些浏览器可能不会显示调用栈信息，这种情况可以通过 arguments.callee.caller 来做栈递归</li></ul> <h4 id="try-catch"><a href="#try-catch" class="header-anchor">#</a> try catch</h4> <p>使用 try... catch 虽然能够较好地进行异常捕获，不至于使得页面由于一处错误挂掉，但 try ... catch 捕获方式显得过于臃肿，大多代码使用 try ... catch 包裹，影响代码可读性。</p> <p>不过，对于异步代码来说，可以使用 catch 的方式捕获错误。比如 Promise 可以直接使用 catch 函数，async await 可以使用 try catch。</p> <h3 id="资源加载错误的捕获方式"><a href="#资源加载错误的捕获方式" class="header-anchor">#</a> 资源加载错误的捕获方式</h3> <h4 id="object-onerror"><a href="#object-onerror" class="header-anchor">#</a> object.onerror</h4> <p>img 标签、script 标签等节点都可以添加 onerror 事件，用来捕获资源加载的错误。</p> <h4 id="performance-getentries"><a href="#performance-getentries" class="header-anchor">#</a> performance.getEntries</h4> <p>performance.getEntries 可以获取所有已加载资源的加载时长，通过这种方式，可以间接的拿到没有加载的资源错误。</p> <p>举例：</p> <p>浏览器打开一个网站，在Console控制台下，输入：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>performance<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 或者输入：</span>
performance<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上面这个api，返回的是数组，既然是数组，就可以用forEach遍历。打印出来的资源就是已经成功加载的资源。</p> <p>再入document.getElementsByTagName('img')，就会显示出所有需要加载的的img集合。</p> <p>于是，<code>document.getElementsByTagName('img')</code> 获取的资源数组减去通过 <code>performance.getEntries()</code> 获取的资源数组，剩下的就是没有成功加载的，这种方式可以间接捕获到资源加载错误。</p> <h3 id="错误上报的两种方式"><a href="#错误上报的两种方式" class="header-anchor">#</a> 错误上报的两种方式</h3> <h4 id="ajax"><a href="#ajax" class="header-anchor">#</a> ajax</h4> <p>采用 Ajax 通信的方式上报（此方式虽然可以上报错误，但是如果是简单的监控我们并不采用这种方式）</p> <h4 id="利用image对象上报"><a href="#利用image对象上报" class="header-anchor">#</a> 利用Image对象上报</h4> <p>利用 Image 对象上报（推荐，网站的监控体系都是采用的这种方式）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//通过Image对象进行错误上报</span>
<span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://smyhvae.com/myPath?badjs=msg'</span><span class="token punctuation">;</span>   <span class="token comment">// myPath表示上报的路径（我要上报到哪里去）。后面的内容是自己加的参数。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这种方式，不需要借助第三方的库，一行代码即可搞定。</p> <h3 id="遇到的问题"><a href="#遇到的问题" class="header-anchor">#</a> 遇到的问题</h3> <p>通常在生产环境下的代码是经过 webpack 打包后压缩混淆的代码，所以我们可能会遇到所有的报错的代码行数都在第一行了，这是因为在生产环境下，我们的代码被压缩成了一行。</p> <p>解决办法是开启 webpack 的 source-map，我们利用 webpack 打包后的生成的一份 .map 的脚本文件就可以让浏览器对错误位置进行追踪了。</p> <p>但是问题又来了：</p> <ul><li>直接在生产环境使用 source-map 文件，会暴露源码，怎么办？</li> <li>source-map 在部分浏览器不兼容，怎么办?</li></ul> <p>针对第一个问题，我们可能可以把完整的 source-map 包换成 cheap-module-source-map，这样只会暴露错误所在的文件和代码行号，就不会暴露源码了。但是这样还是无法解决不兼容的问题。</p> <p>针对第二个问题，可以使用引入 npm 库来支持 source-map，可以参考 <a href="https://github.com/mozilla/source-map" target="_blank" rel="noopener noreferrer">mozilla/source-map<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这个 npm 库既可以运行在客户端也可以运行在服务端，不过更为推荐的是在服务端使用 Node.js 对接收到的日志信息时使用 source-map 解析，以避免源代码的泄露造成风险，如下代码所示：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sourceMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'source-map'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">file</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 定义post接口</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/error/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取前端传过来的报错对象</span>
    <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> error<span class="token punctuation">.</span>scriptURI<span class="token punctuation">;</span> <span class="token comment">// 压缩文件路径</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> fileUrl <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'client/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.map'</span><span class="token punctuation">;</span> <span class="token comment">// map文件路径</span>
        <span class="token comment">// 解析sourceMap</span>
        <span class="token keyword">let</span> consumer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">sourceMap<span class="token punctuation">.</span>SourceMapConsumer</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'../'</span> <span class="token operator">+</span> fileUrl<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回一个promise对象</span>
        <span class="token comment">// 解析原始报错数据</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">originalPositionFor</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            line<span class="token operator">:</span> error<span class="token punctuation">.</span>lineNo<span class="token punctuation">,</span> <span class="token comment">// 压缩后的行号</span>
            column<span class="token operator">:</span> error<span class="token punctuation">.</span>columnNo <span class="token comment">// 压缩后的列号</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>针对第二个问题找到的其它解决方案:</p> <p>需要服务器配置 .js.map 后缀的文件不可访问。  如果这样的话，服务器解析的时候不能直接去下载静态资源 .map 文件，而是需要去找到服务器本地对应的 map 文件，这样要单独配置路径和写逻辑很麻烦，而且文件夹结构有变动的话也不灵活。  所以我们的方案是做token权限校验，map 文件必须加正确的 token 参数，服务器才会返回资源（xxx.js.map?token=xxxx），否则 nginx 会屏蔽没有 token 或者 token 错误的请求。</p> <p>这种方式就不需要单独在通过服务端接口解析了</p> <h3 id="vue-和-react-捕获异常"><a href="#vue-和-react-捕获异常" class="header-anchor">#</a> Vue 和 React 捕获异常</h3> <p><strong>Vue</strong></p> <p>正常我们捕获不到 Vue 组件的异常，查阅资料得知，在 Vue 中，异常可能被 Vue 自身给 <code>try ... catch</code> 了，不会传到 <code>window.onerror</code> 事件触发，那么我们如何把 Vue 组件中的异常作统一捕获呢？</p> <p>使用 <a href="https://cn.vuejs.org/v2/api/#errorHandler" target="_blank" rel="noopener noreferrer">Vue.config.errorHandler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这样的 Vue 全局配置，可以在 Vue 指定组件的渲染和观察期间未捕获错误的处理函数。这个处理函数被调用时，可获取错误信息和 Vue 实例。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle error</span>
  <span class="token comment">// `info` 是 Vue 特定的错误信息，比如错误所在的生命周期钩子</span>
  <span class="token comment">// 只在 2.2.0+ 可用</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>React</strong></p> <p>在 React 中，可以使用 <code>ErrorBoundary</code> 组件包括业务组件的方式进行异常捕获，配合 React 16.0+ 新出的 <code>componentDidCatch API</code>，可以实现统一的异常捕获和日志上报。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> hasError<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Display fallback UI</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hasError<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// You can also log the error to an error reporting service</span>
    <span class="token function">logErrorToMyService</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// You can render any custom fallback UI</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Something went wrong<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>使用方式如下：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ErrorBoundary</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyWidget</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ErrorBoundary</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="实际使用后的优化"><a href="#实际使用后的优化" class="header-anchor">#</a> 实际使用后的优化</h3> <ul><li><p>我们发现不同的浏览器报错的变量可能不一样，同一个报错在chrome浏览器和firefox上 columnNo 参数一点偏差。  用两种报错解析了一下，如下图，报错的代码都是18行，是没问题的，Firefox报错是下图第一个：console 18 0 true，chrome是testBase 18 0 true，行数没问题，偏差不影响我们最终查错，我的18行源代码是：console.log(testBase)。  testBase是故意没有申明，testBase是undefined，出问题的应该是testBase这个变量，过从报错情况上看，确实是谷歌浏览器更精准一点。  虽然不在意IE，不过IE11报错列数和firefox一致。</p></li> <li><p>页面触发事件报错，用户一直触发按钮，这时就会不停上报错误信息。解决：存储上一个报错信息和时间，进行比对，同一个报错，短时间内避免一直重复发送。</p></li> <li><p>引入监控的项目，由于业务原因可能需要上传一些业务信息方便分析，所以预留一个配置字段，上传错误的时候请求会带上业务相关信息。</p></li></ul> <h2 id="页面埋点"><a href="#页面埋点" class="header-anchor">#</a> 页面埋点</h2> <p>页面埋点应该是大家最常写的监控了，一般起码会监控以下几个数据：</p> <ul><li>PV / UV</li> <li>停留时长</li> <li>流量来源</li> <li>用户交互</li></ul> <p>对于这几类统计，一般的实现思路大致可以分为两种，分别为手写埋点和无埋点的方式。</p> <p>相信第一种方式也是大家最常用的方式，可以自主选择需要监控的数据然后在相应的地方写入代码。这种方式的灵活性很大，但是唯一的缺点就是工作量较大，每个需要监控的地方都得插入代码。</p> <p>另一种无埋点的方式基本不需要开发者手写埋点了，而是统计所有的事件并且定时上报。这种方式虽然没有前一种方式繁琐了，但是因为统计的是所有事件，所以还需要后期过滤出需要的数据。</p> <h2 id="开源的解决方案"><a href="#开源的解决方案" class="header-anchor">#</a> 开源的解决方案</h2> <p>一些开源的解决方案，比如腾讯的 badjs，淘宝的 JSTracker，阿里巴巴的 FdSafe，支付宝的 saijs，国外的 sentry 和对应的前端 sdk ravenjs，包括对应的 TraceKit。</p> <p>目前主流的前端监控系统，包括一些收费服务，国内比如 fundebug，产品功能和 sentry 还真像，只不过他只关注前端，sentry 关注所有的 Error 收集场景，他们解决的问题其实都是本文要说到的一些通用问题，但是针对到具体项目适合不适合，就要看业务方自己选择了。</p> <p>其中个人觉得 sentry 是比较好的选择，有以下几点：</p> <ul><li>开源</li> <li>对各种前端框架的友好支持 (Vue、React、Angular)</li> <li>支持 SourceMap</li></ul> <p>Sentry 官方提供的免费服务有次数限制，达到一定限制后继续使用就需要收费了，但是我们可以利用 Sentry 的开源库在自己的服务器上搭建服务，官方已经提供了完善的操作文档。</p> <p>有兴趣的童鞋可以参考 Sentry 搭建错误监控系统：
<a href="https://zhuanlan.zhihu.com/p/51446011" target="_blank" rel="noopener noreferrer">超详细！搭建一个前端错误监控系统<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>参考链接：</p> <p><a href="https://juejin.cn/post/6844903648355418120#heading-14" target="_blank" rel="noopener noreferrer">前端性能与异常上报<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6844903540385644557#heading-8" target="_blank" rel="noopener noreferrer">从无到有&lt;前端异常监控系统&gt;落地<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://yuchengkai.cn/docs/frontend/#promise-%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">前端面试之道<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/interview/pages/interview notes/安全防范知识点.html" class="prev">
        安全防范知识点
      </a></span> <span class="next"><a href="/interview/pages/interview notes/你能实现一个没有漏洞的双向绑定吗.html">
        你能实现一个没有漏洞的双向绑定吗
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/interview/assets/js/app.315fcd90.js" defer></script><script src="/interview/assets/js/3.2951d97b.js" defer></script><script src="/interview/assets/js/37.1834af1c.js" defer></script>
  </body>
</html>
